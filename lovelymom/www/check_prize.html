{% extends "templates/web.html" %}

{% block title %}{{ _("Check Your Prize") }}{% endblock %}

{% block style %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
<style>
    body {
        background-color: #f0f4f8;
        font-family: 'Inter', sans-serif;
    }

    .prize-container {
        max-width: 600px;
        margin: 50px auto;
        padding: 40px;
        background: white;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        text-align: center;
        transition: all 0.3s ease;
    }

    .prize-container:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    }

    h1 {
        color: #2d3748;
        margin-bottom: 30px;
        font-weight: 700;
        font-size: 2.5rem;
    }

    .input-group {
        margin-bottom: 25px;
        position: relative;
    }

    input[type="text"] {
        width: 100%;
        padding: 15px 20px;
        font-size: 1.2rem;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        outline: none;
    }

    input[type="text"]:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }

    .btn-check {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 40px;
        font-size: 1.1rem;
        border-radius: 12px;
        cursor: pointer;
        transition: transform 0.2s;
        font-weight: 600;
        width: 100%;
    }

    .btn-check:hover {
        transform: translateY(-2px);
    }

    .btn-check:active {
        transform: translateY(0);
    }

    #result-area {
        margin-top: 30px;
        display: none;
        padding: 20px;
        border-radius: 15px;
    }

    .win {
        background-color: #f0fff4;
        border: 2px solid #68d391;
        color: #276749;
    }

    .loss {
        background-color: #fff5f5;
        border: 2px solid #fc8181;
        color: #9b2c2c;
    }

    .prize-image {
        max-width: 100%;
        height: auto;
        border-radius: 10px;
        margin-top: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .confetti {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 9999;
        display: none;
    }

    .spinner {
        display: none;
        margin: 20px auto;
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #764ba2;
        animation: spin 1s ease infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Interactive Elements */
    .shake {
        animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    }

    @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
    }
</style>
{% endblock %}

{% block page_content %}
<div class="prize-container animate__animated animate__fadeIn">
    <h1>Check Your Prize! ðŸŽ‰</h1>
    
    <div class="input-group">
        <input type="text" id="code-input" placeholder="Enter your unique code here..." autocomplete="off">
    </div>

    <button class="btn-check" onclick="checkPrize()">
        Check Now
    </button>
    
    <div class="spinner" id="loading-spinner"></div>

    <div id="result-area" class="animate__animated">
        <h2 id="result-title"></h2>
        <p id="result-message"></p>
        <div id="prize-img-container"></div>
    </div>
</div>

<canvas class="confetti" id="confetti-canvas"></canvas>

{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<script>
    function checkPrize() {
        const code = document.getElementById('code-input').value.trim();
        const resultArea = document.getElementById('result-area');
        const spinner = document.getElementById('loading-spinner');
        const title = document.getElementById('result-title');
        const msg = document.getElementById('result-message');
        const imgContainer = document.getElementById('prize-img-container');
        const btn = document.querySelector('.btn-check');

        if (!code) {
            frappe.msgprint("Please enter a code!");
            document.getElementById('code-input').classList.add('shake');
            setTimeout(() => document.getElementById('code-input').classList.remove('shake'), 500);
            return;
        }

        // Reset UI
        resultArea.style.display = 'none';
        resultArea.className = 'animate__animated'; // remove win/loss classes
        imgContainer.innerHTML = '';
        spinner.style.display = 'block';
        btn.disabled = true;

        frappe.call({
            method: 'lovelymom.lovelymom.doctype.prize_code.prize_code.validate_code',
            args: {
                code: code
            },
            callback: function(r) {
                spinner.style.display = 'none';
                btn.disabled = false;
                resultArea.style.display = 'block';

                if (r.message && r.message.status === 'success') {
                    const data = r.message;
                    
                    if (data.result_type === 'Win') {
                        resultArea.classList.add('win');
                        resultArea.classList.remove('loss');
                        title.innerText = "Congratulations! You Won!";
                        msg.innerText = `You have won: ${data.prize}`;
                        
                        if (data.image) {
                            imgContainer.innerHTML = `<img src="${data.image}" class="prize-image animate__animated animate__zoomIn">`;
                        }

                        // Confetti
                        document.querySelector('.confetti').style.display = 'block';
                        confetti({
                            particleCount: 150,
                            spread: 70,
                            origin: { y: 0.6 }
                        });
                        setTimeout(() => { document.querySelector('.confetti').style.display = 'none'; }, 5000);

                    } else {
                        resultArea.classList.add('loss');
                        resultArea.classList.remove('win');
                        title.innerText = "Better Luck Next Time!";
                        msg.innerText = "Unfortunately, this code did not win a prize.";
                    }
                    resultArea.classList.add('animate__fadeInUp');

                } else {
                    // Error case (Invalid code, inactive, etc.)
                   frappe.msgprint(r.message.message || "An error occurred");
                }
            }
        });
    }

    // Add Enter key support
    document.getElementById('code-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            checkPrize();
        }
    });
</script>
{% endblock %}
